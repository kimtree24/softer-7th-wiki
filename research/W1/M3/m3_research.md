# ETL 파이프라인 구축 정리 (GDP 데이터)

## 1. Extract 단계에서의 고민

### 1.1 데이터 소스 선택

#### GDP 데이터
- Wikipedia의 국가별 GDP 테이블은 접근이 쉽지만,
  - 비공식 데이터
  - HTML 구조 변경 가능성 존재
- IMF 공식 데이터를 사용하는 것이 더 신뢰도가 높음

#### Region 데이터
- api를 활용해서 Region을 가져오는 방식
- wikipedia에서 가져오는 방식
- world bank에서 가져오는 방식

#### 결론
- Region 데이터는 사업성 평가를 하는 것이므로 world bank에서 가져왔음
- Region의 범위를 어떻게 설정할지는 요구사항을 더 구체화 해서 정해야 할 듯
- Region 데이터와 GDP 데이터의 국가명이 일치하지 않는 경우가 있어서 해당 경우는 수동으로 지정했음
- 국가명 - Region 관계는 처음 1회만 설정되면 추후 수정 가능성이 적을 것이라고 판단하여 수동 처리

### 1.2 전처리를 어디서 할 것인지에 대한 판단
- 데이터 전처리를 extract에서 할 지, transform에서 할 지에 대한 고민이 있었음
- extract는 그냥 원본 데이터만 가져오는 것이라고 판단하여 transform에서 처리하고자 했음

## 2. Transform 단계에서의 고민
### 2.1 값이 없는 경우의 처리
- GDP 값이 없는 경우 이를 null로 저장할지, 아예 무시를 할지 고민이었음
- 요구사항이 사업분석을 위한 것이고, GDP 큰 국가를 대상으로 하는 것이므로 값이 없다면 무시해도 된다고 판단.

### 2.2 GDP 값에 연도가 있는 경우 처리
- 기준 연도가 기본적으로 25년이지만 GDP 값에 괄호로 2024라고 되어 있는 경우 있었음
- 해당 case 경우 2024 데이터와 2025 데이터를 구분할 필요가 있다고 판단하여 새로운 컬럼(year)을 만들어서 구분했음
- 다만 이런 선택은 요구사항에 따라 달라질 필요가 있을 것

### 2.3 ETL 기준 날짜에 대한 고민
- ETL 프로세스가 반복되어서 실행되므로 과거 데이터 이력을 남겨야 한다고 판단.
- 이를 위해서 ETL 실행한 날짜를 update_date로 관리

### 2.4 데이터 구조의 변경
- dict 구조보다 pandas Dataframe 포맷이 DB 친화적이라 하여 해당 데이터 포맷으로 변경

## 3. Load 단계에서의 고민
### 3.1 디비 설계
- 데이터 중복 값을 무시하기 위해서 country-year을 하나의 pk로 묶어서 같은 값이 있는 경우 무시하도록 했음
- 다만 이 경우 분기별로 발표되는 값에 대해서는 갱신이 안되어 다른 방법을 찾아야 할 것 같음

## 4. SQL 실행
### 4.1 문법에 대한 공부
- `WITH` 명령어를 사용하여 임시 window table을 구성하고 이를 바탕으로 top5 출력
- 임시테이블 생성해서 쿼리 수행함이 복잡한 쿼리에서 용이
- `ROW_NUMBER()`는 윈도우 함수 중 하나로 결과 집합의 각 행에 순번을 매겨줌
- 기존 row 개수는 그대로 유지하고 번호 컬럼을 하나 추가해줌
- `GROUP BY()`는 기준 row 개수를 합치는 구조
- `PARTITION BY`는 값이 같은 행끼리 하나의 그룹으로 묶어줌. 이를 바탕으로 `ROW_NUMBER()`의 기준 숫자 시작됨