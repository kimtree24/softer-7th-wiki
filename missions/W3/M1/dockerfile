FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# 기본 패키지 + Java 11 + ssh + 도구들
RUN apt-get update && apt-get install -y \
    openjdk-11-jdk \
    wget curl vim net-tools \
    openssh-server rsync \
    && rm -rf /var/lib/apt/lists/*

# Hadoop 설치
ARG HADOOP_VERSION=3.3.6
ENV HADOOP_HOME=/opt/hadoop
ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-arm64
ENV PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin

RUN wget -q https://downloads.apache.org/hadoop/common/hadoop-${HADOOP_VERSION}/hadoop-${HADOOP_VERSION}.tar.gz \
    && tar -xzf hadoop-${HADOOP_VERSION}.tar.gz -C /opt \
    && mv /opt/hadoop-${HADOOP_VERSION} $HADOOP_HOME \
    && rm hadoop-${HADOOP_VERSION}.tar.gz

# SSH 세팅 (Hadoop start-dfs.sh에서 ssh localhost 사용)
RUN mkdir -p /var/run/sshd
RUN ssh-keygen -A
RUN useradd -m -s /bin/bash hadoop \
    && echo "hadoop:hadoop" | chpasswd \
    && adduser hadoop sudo

USER hadoop
RUN mkdir -p /home/hadoop/.ssh \
    && ssh-keygen -t rsa -P "" -f /home/hadoop/.ssh/id_rsa \
    && cat /home/hadoop/.ssh/id_rsa.pub >> /home/hadoop/.ssh/authorized_keys \
    && chmod 600 /home/hadoop/.ssh/authorized_keys \
    && printf "Host localhost\n  StrictHostKeyChecking no\n  UserKnownHostsFile=/dev/null\n" > /home/hadoop/.ssh/config

USER root

# Hadoop 설정파일 복사
COPY config/*.xml $HADOOP_HOME/etc/hadoop/
COPY start-hadoop.sh /start-hadoop.sh

RUN chmod +x /start-hadoop.sh \
    && chown -R hadoop:hadoop $HADOOP_HOME

# hadoop-env.sh에 JAVA_HOME 지정 (확실히 박아두기)
RUN sed -i "s|^# export JAVA_HOME=.*|export JAVA_HOME=${JAVA_HOME}|" $HADOOP_HOME/etc/hadoop/hadoop-env.sh

# HDFS 데이터 디렉토리 (영속 볼륨으로 사용)
RUN mkdir -p /hadoop/dfs/namenode /hadoop/dfs/datanode \
    && chown -R hadoop:hadoop /hadoop

RUN echo 'export HADOOP_HOME=/opt/hadoop' >> /home/hadoop/.bashrc && \
    echo 'export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin' >> /home/hadoop/.bashrc

# 포트 오픈
EXPOSE 9870 9000 9864 8088 22

# 실행
CMD ["/start-hadoop.sh"]